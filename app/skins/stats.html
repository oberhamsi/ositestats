<% extends 'skins/base.html' %>

<% subskin 'head' %>
<script type="text/javascript" src="<% href /static/handlebars.js %>"></script>
<style>
   tr > th {
      text-align:left;
   }
   tr > td {
      text-align: right;
   }
   table {
      min-width: 200pt;
   }
   caption {
      font-size: x-large;
      font-weight: bold;
      padding: 20px 0 0 0;
   }
</style>
<script type="text/javascript">
var site = "<%site%>";
var TEMPLATES = {};

function renderDistTable(data) {

   var distributions = JSON.parse(data.distributions[0].distributions);
   var keys = [];
   for (var key in distributions) {
      keys.push(key);
   };
   // why wtf?
   /*keys = keys.filter(function(k) {
      return dist.distributions[k];
   });
   */
   keys.sort(function(a, b) {
      return ( (distributions[b] || 0) - (distributions[a] || 0));
   });
   
   var distData = [];
   keys.forEach(function(k) {
      distData.push({key: k, value: distributions[k]});
   });
   
   var result = TEMPLATES.distribution({
      distributionKey: data.distributionKey,
      distributions: distData,
   });
   return result;
};

var WEEKDAY = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
function renderAggregateTable(data, $table) {
   var date = new Date();
   date.setYear(data.timeKey.substr(0, 4));
   date.setMonth(data.timeKey.substr(5, 6));
   var $tbody = $(".sts-tablebody", $table);
   data.aggregates.forEach(function(aggregate) {
      date.setDate(aggregate.day.substr(6,8));
      var $row = $("<tr></tr>");
      $row.append("<th>" + date.getDate() + "<br>" + WEEKDAY[date.getDay()] + ' ' + "</th>");
      $row.append("<td>" + aggregate.hits + "</td>");
      $row.append("<td>" + aggregate.uniques + "</td>");
      $tbody.append($row);
   });
   var currentMonth = date.getMonth();
   date.setDate(date.getDate()+1);
   while(date.getMonth() === currentMonth) {
      var $row = $("<tr></tr>");
      $row.append("<th>" + date.getDate() + '<br>' + WEEKDAY[date.getDay()] + ' ' + "</th>");
      $row.append("<td>" + 0 + "</td>");
      $row.append("<td>" + 0 + "</td>");
      $tbody.append($row);
      date.setDate(date.getDate()+1);
   }
   return;
};

function updateClickGraph(timeKey) {
   $clickgraph = $("#clickgraph");
   var url = $clickgraph.attr("clickGraphPath") + "/" + timeKey + ".png";
   $clickgraph.attr("src", url);
   return;
};

function onTimeKeyChange() {
   var timeKey = $(this).val();
   document.location.hash = timeKey;
   // clear old data
   
   // clickgraph img src update
   updateClickGraph(timeKey);
   
   // aggregates hits, uniques
   $.get('/aggregatedata/<%site%>/' + timeKey, function(data) {
      renderAggregateTable(data, $('table#hits'));
   });
   
   // aggregates hits, uniques for whole month
   $.get('/aggregatedata/<%site%>/' + timeKey.substr(0,4), function(data) {
      var currentMonthAggregate = null;
      data.aggregates.some(function(aggregate) {
         if (aggregate.month == timeKey) {
            currentMonthAggregate = aggregate;
            return true;
         }
         return false;
      });
      if (!currentMonthAggregate) return;
      
      $("#monthUniques").html(currentMonthAggregate.uniques);
      $("#monthHits").html(currentMonthAggregate.hits);
   });

   // render distributions, pages, referers, useragents
   var distOps = {
      parseDirection: 'x',
      appendTitle: false,
      type: 'pie',
      width: 400,
      height: 400,
   };

   var $distributions = $("#distributions");
   $.get('/distributiondata/<%site%>/page/' + timeKey, function(data) {
      $distributions.append(renderDistTable(data, $("table#page")));
   });
   $.get('/distributiondata/<%site%>/referer/' + timeKey, function(data) {
      $distributions.append(renderDistTable(data, $("table#referer")));
   });
   $.get('/distributiondata/<%site%>/userAgent/' + timeKey, function(data) {
      $distributions.append(renderDistTable(data, $("table#useragents")));
   });
};

$(document).ready(function() {
   TEMPLATES.distribution = Handlebars.compile($('[template=distribution]').text());
   
   $('#timeKey').change(onTimeKeyChange);
   var timeKey = document.location.hash && document.location.hash.substr(1) || "<% timeKey %>";
   $('#timeKey').val(timeKey);
   $('#timeKey').trigger('change');
   return;
});
</script>

<% subskin 'content' %>
<div>
<a href="<% href / %>">Dashboard</a>
</div>

<h1> <%site%>, <select id="timeKey"><% for timeKey in <% timeKeys %> render timeKeyOption %></select></h1>

<div id="monthOverview">
   <h3> Monthly total: <span id="monthHits"></span> Hits from <span id="monthUniques"></span> Uniques.</h3>
</div>

<div>
   <div id="vishits" class="visualize" style="float:left;">
   </div>
<br style="clear:both"/>
<table id='hits' style="display:none">
	<caption></caption>
	<thead>
		<tr class="sts-tablehead">
		   <td>Date</td>
			<th scope="row">Hits</th>
			<th scope="row">Uniques</th>
		</tr>
	</thead>
	<tbody class="sts-tablebody">
	</tbody>
   </table>
</div>


<div class="distributioncontainer">
   <h3> Clickgraph </h3>

   <a href="<% clickGraphPath <% site %> %><% timeKey %>.png">
      <img id="clickgraph" clickGraphPath="<% clickGraphPath <% site %> %>" 
            src="<% clickGraphPath <% site %> %><% timeKey %>.png"/>
   </a>
</div>

<div id="distributions">

</div>

<script template="distribution" type="handlebarjs">
   {{wtf}}
   <table>
      <caption>{{distributionKey}}</caption>
      {{#distributions}}
         <tr>
            <th>{{key}}</th>
            <td>{{value}}</td>
         </tr>
      {{/distributions}}
   </table>
</script>

<% subskin timeKeyOption %>
<option value="<% timeKey %>"> <% timeKey | keyToDate | dateFormat "MM/yyyy" %>
